<h1 class="title">ğŸ—ºï¸ åœ°å›³è¡¨ç¤ºã‚¢ãƒ—ãƒª</h1>

<div class="card">
  <%= form_with url: maps_path, method: :get, local: true, html: { class: "form-area" } do |f| %>
    <div class="input-group">
      <%= f.label :city, "éƒ½å¸‚åã‚’å…¥åŠ›", class: "label" %>
      <%= f.text_field :city, value: params[:city], class: "input" %>
      <%= f.submit "åœ°å›³è¡¨ç¤º", class: "button" %>
      <button type="button" id="current-location-btn" class="button-outline">
        ğŸ“ ç¾åœ¨åœ°ã‚’è¡¨ç¤º
      </button>
    </div>
  <% end %>
</div>

<div id="map" class="map"></div>

<% if @cities.present? %>
  <div class="recent-cities">
    <h3>ğŸ•’ æœ€è¿‘æ¤œç´¢ã—ãŸéƒ½å¸‚</h3>
    <ul>
      <% @cities.each do |c| %>
        <li><%= link_to c, maps_path(city: c) %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<% if params[:city].present? %>
  <script>
    async function initMap() {
      const city = "<%= j params[:city] %>";

      const res = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(city)}&key=<%= ENV["GOOGLE_MAPS_API_KEY"] %>`);
      const data = await res.json();

      if (data.status === "OK") {
        const location = data.results[0].geometry.location;
        const map = new google.maps.Map(document.getElementById("map"), {
          center: location,
          zoom: 11,
        });

        new google.maps.Marker({
          position: location,
          map: map,
          title: city,
        });
      } else {
        alert("éƒ½å¸‚ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼");
      }
    }

    document.getElementById("current-location-btn").addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const userLocation = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
            };
            const map = new google.maps.Map(document.getElementById("map"), {
              center: userLocation,
              zoom: 12,
            });
            new google.maps.Marker({
              position: userLocation,
              map: map,
              title: "ç¾åœ¨åœ°",
            });
          },
          () => alert("ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")
        );
      } else {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
      }
    });
    window.initMap = initMap;
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= ENV["GOOGLE_MAPS_API_KEY"] %>&callback=initMap"></script>
<% end %>